use crate::keyboard::{MediaCode, Modifier, WellKnownCode};
use num::FromPrimitive;

pub struct Decoder {}

struct KeyCode {
    #[allow(unused)]
    modifier: Option<Modifier>,
    #[allow(unused)]
    media_code: Option<MediaCode>,
    #[allow(unused)]
    wkc: WellKnownCode,
}

pub struct DeviceInformation {
    pub num_keys: u8,
    pub num_encoders: u8,
}

pub struct KeyMapping {
    pub delay: u16,
    pub layer: u8,
    pub key_number: u8,
    pub keys: Vec<u8>,
}

impl Decoder {
    pub fn get_device_info(buf: &[u8]) -> DeviceInformation {
        DeviceInformation {
            num_keys: buf[2],
            num_encoders: buf[3],
        }
    }

    pub fn get_key_mapping(buf: &[u8]) -> KeyMapping {
        let mut key_press = Vec::new();
        let _is_mouse = buf[10] & 0x04; // FIXME: implement
        let mut i = 11;
        loop {
            let val = Self::get_key(&[buf[i], buf[i + 1]]);
            if val.is_none() {
                break; // short circuit
            }

            // TODO: get the mapping
            key_press.push(val);

            i += 2;
            if i > 45 {
                break; // end of mapping space in usb response
            }
        }
        KeyMapping {
            delay: u16::from_be_bytes([buf[5], buf[6]]),
            layer: buf[3],
            key_number: buf[2],
            keys: Vec::new(),
        }
    }

    fn get_key(buf: &[u8]) -> Option<KeyCode> {
        let val = u16::from_be_bytes([buf[0], buf[1]]);
        if val == 0 {
            return None;
        }

        // get the key/mouse combination
        /*
        let da_key = <WellKnownCode as FromPrimitive>::from_u32(buf[1].into())?;
        println!("key: {}", da_key);
        Some(KeyCode {
            modifier: None,
            media_code: None,
            wkc: da_key,
        })
        */

        None
    }
}

// enum stuff - https://enodev.fr/posts/rusticity-convert-an-integer-to-an-enum.html

// macropad device probe response - 6 button 1 encoder
// 03fb060100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

// layer 1
// key 1 = ctrl+a
// 03fa010101000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 2 = alt+shift
// 03fa020101000000000001060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 3 = ctrl+alt+b
// 03fa030101000000000002050001050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 4 = null
// 03fa040101000000000001006400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 5 = k
// 03fa050101000000000001000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 6 = l
// 03fa060101000000000001000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 16 = mouse wheel +
// 03fa100103000000000004000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 17 = mouse left click
// 03fa110103000000000004000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 18 = mouse wheel -
// 03fa12010300000000000400000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

// layer 2
// key 16 = left arrow
// 03fa100201000000000001005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 17 = enter
// 03fa110201000000000001002800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 18 = right arrow
// 03fa120201000000000001004f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

// layer 3
// key 1 = play/pause
// 03fa010302000000000001cd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 2 = next track
// 03fa020302000000000001b50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 3 = mute
// 03fa030302000000000001e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 4 = 3
// 03fa040301000000000001002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 5 = 4
// 03fa050301000000000001002100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 6 = 5
// 03fa060301000000000001002200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 16 = volume -
// 03fa100302000000000001ea0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 17 = mute
// 03fa110302000000000001e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// key 18 = volume +
// 03fa120302000000000001e90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
